<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner QR - ZXing Alternative</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
        }
        
        #scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            text-align: center;
        }
        
        video {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            border: 2px solid #1e40af;
        }
        
        .btn {
            background: #1e40af;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            width: 100%;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .success {
            background: #dcfce7;
            color: #047857;
            border: 2px solid #10b981;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
            border: 2px solid #ef4444;
        }
        
        .manual-input {
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé´ Scanner QR Badge - ZXing</h1>
        
        <div id="scanner-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
        
        <button class="btn" id="startBtn">üì∑ D√©marrer Scanner ZXing</button>
        <button class="btn" id="stopBtn" style="display: none;">‚èπÔ∏è Arr√™ter Scanner</button>
        
        <div class="manual-input">
            <h3>Mode Manuel</h3>
            <input type="text" id="manualCode" placeholder="Code badge (ex: C01)" />
            <button class="btn" id="manualBtn">‚úÖ Valider</button>
        </div>
        
        <div id="result" style="display: none;"></div>
    </div>

    <!-- ZXing Library -->
    <script src="https://unpkg.com/@zxing/library@latest/umd/index.js"></script>
    
    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbwd87tDGQ0rF9qnd2lrfKjWG3oCQ_LkHcILscimm13xvEXAZOZmFKivTSSZlHVwA8F0/exec';
        
        // Variables globales
        let codeReader = null;
        let stream = null;
        let isScanning = false;
        
        // √âl√©ments DOM
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const manualCode = document.getElementById('manualCode');
        const manualBtn = document.getElementById('manualBtn');
        const result = document.getElementById('result');
        
        // Initialisation ZXing
        function initializeZXing() {
            try {
                codeReader = new ZXing.BrowserQRCodeReader();
                console.log('ZXing initialis√© avec succ√®s');
            } catch (error) {
                console.error('Erreur initialisation ZXing:', error);
                showResult('Erreur: ZXing non disponible', 'error');
            }
        }
        
        // D√©marrer le scanner ZXing
        async function startScanning() {
            try {
                if (!codeReader) {
                    initializeZXing();
                }
                
                // Obtenir les cam√©ras disponibles
                const videoInputDevices = await codeReader.listVideoInputDevices();
                console.log('Cam√©ras disponibles:', videoInputDevices.length);
                
                // Utiliser la cam√©ra arri√®re si disponible
                let selectedDeviceId = videoInputDevices[0]?.deviceId;
                
                // Chercher la cam√©ra arri√®re
                for (const device of videoInputDevices) {
                    if (device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment')) {
                        selectedDeviceId = device.deviceId;
                        break;
                    }
                }
                
                // D√©marrer le scan
                const result = await codeReader.decodeOnceFromVideoDevice(selectedDeviceId, 'video');
                
                if (result) {
                    console.log('QR Code d√©tect√©:', result.text);
                    onScanSuccess(result.text);
                }
                
            } catch (error) {
                console.error('Erreur scan ZXing:', error);
                
                if (error.name === 'NotAllowedError') {
                    showResult('Acc√®s cam√©ra refus√©. Autorisez l\'acc√®s dans les param√®tres.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showResult('Aucune cam√©ra trouv√©e.', 'error');
                } else {
                    showResult('Erreur scanner: ' + error.message, 'error');
                }
            }
        }
        
        // Arr√™ter le scanner
        function stopScanning() {
            try {
                if (codeReader) {
                    codeReader.reset();
                }
                
                // Arr√™ter le stream vid√©o
                if (video.srcObject) {
                    const tracks = video.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                isScanning = false;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                
                console.log('Scanner arr√™t√©');
                
            } catch (error) {
                console.error('Erreur arr√™t scanner:', error);
            }
        }
        
        // Scanner en continu (alternative)
        async function startContinuousScanning() {
            try {
                if (!codeReader) {
                    initializeZXing();
                }
                
                isScanning = true;
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                
                // Scanner en continu
                await codeReader.decodeFromVideoDevice(null, 'video', (result, error) => {
                    if (result) {
                        console.log('QR Code d√©tect√© (continu):', result.text);
                        onScanSuccess(result.text);
                        stopScanning(); // Arr√™ter apr√®s d√©tection
                    }
                    
                    if (error && !(error instanceof ZXing.NotFoundException)) {
                        console.error('Erreur scan continu:', error);
                    }
                });
                
            } catch (error) {
                console.error('Erreur scanner continu:', error);
                showResult('Erreur scanner continu: ' + error.message, 'error');
                stopScanning();
            }
        }
        
        // Succ√®s du scan
        function onScanSuccess(qrText) {
            console.log('QR Code scann√©:', qrText);
            
            const badgeCode = qrText.trim().toUpperCase();
            showResult(`Badge scann√©: ${badgeCode}`, 'success');
            
            // Envoyer √† l'API
            validateBadge(badgeCode);
        }
        
        // Valider le badge avec l'API
        async function validateBadge(code) {
            try {
                showResult(`Validation du badge ${code}...`, 'info');
                
                const params = new URLSearchParams({
                    action: 'scan_badge',
                    code: code,
                    agent: 'Agent_ZXing',
                    type: 'Entr√©e'
                });
                
                const url = `${API_URL}?${params.toString()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    showResult(`‚úÖ Acc√®s autoris√© - ${data.data?.nom_porteur || 'Porteur non d√©fini'}`, 'success');
                } else {
                    showResult(`‚ùå Acc√®s refus√© - ${data.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Erreur validation:', error);
                showResult(`Erreur validation: ${error.message}`, 'error');
            }
        }
        
        // Afficher r√©sultat
        function showResult(message, type) {
            result.style.display = 'block';
            result.textContent = message;
            result.className = `result ${type}`;
            
            // Masquer apr√®s 5 secondes pour les succ√®s
            if (type === 'success') {
                setTimeout(() => {
                    result.style.display = 'none';
                }, 5000);
            }
        }
        
        // √âv√©nements
        startBtn.addEventListener('click', startContinuousScanning);
        stopBtn.addEventListener('click', stopScanning);
        
        manualBtn.addEventListener('click', () => {
            const code = manualCode.value.trim().toUpperCase();
            if (code) {
                validateBadge(code);
                manualCode.value = '';
            } else {
                showResult('Veuillez saisir un code badge', 'error');
            }
        });
        
        manualCode.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                manualBtn.click();
            }
        });
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initializeZXing();
        });
        
        // Nettoyage √† la fermeture
        window.addEventListener('beforeunload', () => {
            stopScanning();
        });
        
        console.log('Scanner ZXing charg√© et pr√™t');
    </script>
</body>
</html>
